{% extends "base.html" %}
{% block content %}

<h2 class="text-3xl font-bold text-gray-900 mb-6 tracking-wide">
  Upload & Manage Notes
</h2>

<p class="text-gray-600 mb-8">
  Select a department, semester, and subject to upload notes.
  You can also delete old notes below.
</p>

<!-- UPLOAD FORM -->
<div class="bg-white shadow p-6 rounded-xl border border-gray-200 mb-10">

  <h3 class="text-xl font-semibold mb-4">Upload New Note</h3>

  <form method="POST" enctype="multipart/form-data" class="grid gap-5">

    <input type="hidden" name="action" value="add_note">

    <!-- DEPARTMENT -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
      <select name="dept_id" id="deptSelect" required
              class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-gray-900">
        <option value="">Select Department</option>
        {% for d in departments %}
          <option value="{{ d.id }}">{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- SEMESTER -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
      <select name="sem_id" id="semSelect" required
              class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-gray-900">
        <option value="">Select Semester</option>
      </select>
    </div>

    <!-- SUBJECT -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
      <select name="sub_id" id="subSelect" required
              class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-gray-900">
        <option value="">Select Subject</option>
      </select>
    </div>

    <!-- TITLE -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Note Title</label>
      <input name="title"
             placeholder="e.g. Python Unit 1 Notes"
             required
             class="border border-gray-300 rounded-lg p-2 w-full focus:ring-2 focus:ring-gray-900">
    </div>

    <!-- FILE -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Upload PDF</label>
      <input type="file" name="note_pdf" accept="application/pdf" required
             class="block w-full border border-gray-300 rounded-lg p-2">
    </div>

    <!-- SUBMIT -->
    <button
      class="w-full bg-gray-900 text-white py-2 rounded-lg shadow hover:bg-gray-800 transition">
      Upload Note
    </button>

  </form>

</div>

<!-- MANAGE NOTES -->
<h3 class="text-2xl font-bold text-gray-900 mb-4">Existing Notes</h3>

{% if notes|length == 0 %}
  <p class="text-gray-500 mb-10">No notes uploaded yet.</p>
{% endif %}

<div class="grid gap-6 md:grid-cols-2">

  {% for note in notes %}
  <div class="bg-white border border-gray-200 shadow p-5 rounded-xl">

    <div class="text-xl font-semibold text-gray-900 mb-1">
      {{ note.title }}
    </div>

    <div class="text-sm text-gray-500 mb-3">
      Dept: {{ note.dept_id }} • Sem: {{ note.semester_id }} • Sub: {{ note.subject_id }}
      <br>
      Uploaded: {{ note.uploaded_at }}
    </div>

    <!-- VIEW PDF -->
    <a href="{{ note.file_path }}"
       class="text-blue-700 hover:underline text-sm"
       target="_blank">
      View PDF
    </a>

    <!-- DELETE BUTTON -->
    <form method="POST" class="mt-3">
      <input type="hidden" name="action" value="delete_note">
      <input type="hidden" name="note_id" value="{{ note.id }}">
      <button class="text-red-600 text-sm hover:underline">
        Delete Note
      </button>
    </form>

  </div>
  {% endfor %}

</div>

<!-- SCRIPT FOR CONNECTED DROPDOWNS -->
<script>
// @ts-nocheck  // prevent VS Code errors

// FIXED JSON PARSE METHOD
const departments = JSON.parse(`{{ departments | tojson | safe }}`);

const deptSelect = document.getElementById("deptSelect");
const semSelect = document.getElementById("semSelect");
const subSelect = document.getElementById("subSelect");

function resetDropdown(drop, label) {
  drop.innerHTML = `<option value="">${label}</option>`;
}

// When department changes
deptSelect.addEventListener("change", () => {
  const deptId = deptSelect.value;

  resetDropdown(semSelect, "Select Semester");
  resetDropdown(subSelect, "Select Subject");

  if (!deptId) return;

  const dept = departments.find(d => d.id.toLowerCase() === deptId.toLowerCase());
  if (!dept) return;

  dept.semesters.forEach(sem =>
    semSelect.innerHTML += `<option value="${sem.id}">${sem.name}</option>`
  );
});

// When semester changes
semSelect.addEventListener("change", () => {
  const deptId = deptSelect.value;
  const semId = semSelect.value;

  resetDropdown(subSelect, "Select Subject");

  if (!deptId || !semId) return;

  const dept = departments.find(d => d.id.toLowerCase() === deptId.toLowerCase());
  const sem = dept.semesters.find(s => s.id === semId);

  if (!sem) return;

  sem.subjects.forEach(sub =>
    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`
  );
});
</script>

{% endblock %}
